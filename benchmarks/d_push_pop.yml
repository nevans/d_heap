---
prelude: |
  system("#{RbConfig.ruby} bin/rake compile", err: :out, exception: true)
  require "d_heap"

  # this is >4x faster than calling Kernel#rand (see random_vals.yml)
  random_idx  = -1
  random_len  = 1_000_000
  random_vals = Array.new(random_len) { rand(0..100_000_000) }

  N = ENV.fetch("BENCH_N", 100_000).to_i

  i = 1
  low_n = nil
  high_n = nil

  prefill = -> (d) {
    D = d
    raise "D is too big for that N" if N - D/2 < 0
    low_n = N - D/2
    high_n = N + (D-1)/2
    raise "bad N range: (#{low_n}...#{high_n})" unless high_n - low_n == D - 1
    q = DHeap.new(d: D)
    N.times do
      random_idx += 1
      q << random_vals.fetch(random_idx % random_len)
    end
    q
  }

  # in order to avoid any oddities that might come from pushing and popping to a
  # heap that is always the exact same size, +/-1, we'll introduce some
  # non-random "jitter", by growing or shrinking the heap every so often.

  # how many reps between each "jitter" size adjustment
  REPS_PER_SIZE_ADJUSTMENT = 10_000

  # Because sift-up is simple and very fast, and sift-down is where most of the
  # performance gains are made, we'll sift-down (i.e. pop) one at a time, but
  # sift-up (i.e. push) all at once.  We'll go from (N+D/2) down to (N-D/2)

benchmark:
  - name: "d=2"
    prelude: "q = prefill[2]"
    script: &script |
      random_idx += 1
      q << random_vals.fetch(random_idx % random_len)
      q.pop
      if i % REPS_PER_SIZE_ADJUSTMENT == 0
        if q.size == low_n
          D.times { q << random_vals.fetch(random_idx % random_len) }
          $stderr.puts "#{q.size}: #{q.size % D}"
        else
          q.pop
          $stderr.puts "#{q.size}: #{q.size % D}"
        end
      end
      i += 1
  - name: "d=3"
    prelude: "q = prefill[3]"
    script: *script
  - name: "d=4"
    prelude: "q = prefill[4]"
    script: *script
  - name: "d=5"
    prelude: "q = prefill[5]"
    script: *script
  - name: "d=6"
    prelude: "q = prefill[6]"
    script: *script
  - name: "d=7"
    prelude: "q = prefill[7]"
    script: *script
  - name: "d=8"
    prelude: "q = prefill[8]"
    script: *script
  - name: "d=10"
    prelude: "q = prefill[10]"
    script: *script
  - name: "d=12"
    prelude: "q = prefill[12]"
    script: *script
  - name: "d=14"
    prelude: "q = prefill[11]"
    script: *script
  - name: "d=16"
    prelude: "q = prefill[16]"
    script: *script
  - name: "d=24"
    prelude: "q = prefill[24]"
    script: *script
  - name: "d=32"
    prelude: "q = prefill[32]"
    script: *script
